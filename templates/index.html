<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Medical Report Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header class="site-header" role="banner">
        <div class="container topbar">
            <div class="brand">
                <div class="brand-mark" aria-hidden="true">üìÑ</div>
                <div>
                    <h1 class="app-title">AI Medical Report Analyzer</h1>
                    <p class="app-subtitle">Securely analyze your medical reports and get clear insights.</p>
                </div>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h2 class="hero-title">Understand Your Health, Instantly</h2>
            <p class="hero-subtitle">Upload your medical reports, and our secure AI will help you understand complex medical terms, test results, and more.</p>
            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">üîí</div>
                    <h3 class="feature-title">Confidential & Secure</h3>
                    <p>Your medical reports are encrypted and processed with the utmost confidentiality. We prioritize your privacy.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üî¨</div>
                    <h3 class="feature-title">Intelligent Analysis</h3>
                    <p>Our AI breaks down complex medical jargon, lab results, and diagnoses into easy-to-understand language.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ù§Ô∏è</div>
                    <h3 class="feature-title">Ask Health Questions</h3>
                    <p>Ask specific questions about your reports and get clear, AI-powered answers to help you prepare for doctor's appointments.</p>
                </div>
            </div>
            <a href="#upload-section" class="btn btn-primary hero-cta">Get Started</a>
        </div>
    </section>

    <main class="container" role="main">
        <div class="accordion">
            <details class="card compact" id="upload-section" open>
                <summary class="section-title" id="uploaded-files-title">üìÇ Upload Your Medical Report</summary>
                <div class="details-content">
                    <form id="uploadForm" class="form form-vertical">
                        <label for="file" id="dropzone" class="dropzone" aria-label="Upload documents by clicking or dragging files">
                            <input id="file" type="file" name="file" accept=".pdf,.txt,.csv">
                            <div class="dropzone-content">
                                <div class="dropzone-icon">‚¨ÜÔ∏è</div>
                                <div>
                                    <div class="dropzone-title">Drag & drop your report (PDF, TXT, CSV)</div>
                                    <div class="dropzone-subtitle">or click to browse</div>
                                </div>
                            </div>
                        </label>
                        <div class="upload-controls">
                            <button id="uploadBtn" class="btn" type="submit">Upload File</button>
                            <button id="changeFileBtn" class="btn btn-secondary" type="button" title="Choose a different file">Change file</button>
                        </div>

                        <div id="uploadSpinner" class="spinner hidden" role="status" aria-live="polite">
                            <div class="spinner-dot"></div>
                            <div class="spinner-dot"></div>
                            <div class="spinner-dot"></div>
                            <div class="spinner-text">Uploading‚Ä¶</div>
                        </div>

                        <div id="uploadSuccess" class="success hidden"></div>
                        <div id="uploadError" class="error hidden"></div>

                        <div id="fileMeta" class="file-meta">
                            <span id="fileName" class="file-name"></span>
                            <span id="fileSize" class="file-size"></span>
                            <span id="fileStatus" class="file-status"></span>
                        </div>
                    </form>
                </div>
            </details>

            <details class="card compact" id="question-section">
                <summary class="section-title" id="your-questions-title">‚ùì Ask a Question</summary>
                <div class="details-content">
                    <form id="askForm" class="composer" method="POST">
                        <textarea id="query" class="composer-input" name="query" rows="1" placeholder="e.g., 'What does high creatinine mean?'" required></textarea>
                        <div class="composer-actions">
                           
                            <button id="sendBtn" class="send-btn" type="submit" title="Send">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                            </button>
                        </div>
                    </form>

                    <div id="typing" class="typing hidden">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>
            </details>
        </div>

        <div class="disclaimer-box">
            <p><strong>Important:</strong> The analysis provided by this AI is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition.</p>
        </div>

        <section class="card" aria-labelledby="ai-responses-title">
            <h2 class="section-title with-icon" id="ai-responses-title"><span class="bot-icon" aria-hidden="true">ü§ñ</span> AI Analysis</h2>

            <div class="chat">
                {% if last_query %}
                <div class="bubble bubble-user">
                    <div class="bubble-meta">You</div>
                    <div class="bubble-content">{{ last_query }}</div>
                </div>
                {% endif %}

                {% if answer %}
                <div class="answer-card" id="aiAnswer" data-answer='{{ answer|tojson }}'>
                    <div class="answer-row">
                        <div class="answer-col">
                            <h3 class="answer-subtitle">Short answer</h3>
                            <div class="answer-short" id="answerShort"></div>
                        </div>
                        <div class="answer-col">
                            <h3 class="answer-subtitle">Details</h3>
                            <div class="answer-details" id="answerDetails"></div>
                        </div>
                    </div>
                    <div class="answer-row">
                        <div class="answer-col">
                            <h3 class="answer-subtitle">References</h3>
                            <div class="answer-refs" id="answerRefs"></div>
                        </div>
                        <div class="answer-col">
                            <h3 class="answer-subtitle">Next step</h3>
                            <div class="answer-next" id="answerNext"></div>
                        </div>
                    </div>
                    <div class="answer-actions">
                        <button class="mini-btn copy-btn" data-copy="{{ answer }}" title="Copy to clipboard">üìã Copy</button>
                    </div>
                </div>
                {% endif %}

                {% if risk_flag %}
                <div id="riskAlert" class="risk-alert" data-risk="{{ risk_flag }}">
                    <div class="risk-icon"></div>
                    <div>
                        <div class="risk-title"></div>
                        <div class="risk-suggestion"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </section>
        
        
    </main>
    <details class="card compact" id="report-section">
        <summary class="section-title">üìë Structured Clinical Report</summary>
        <div class="details-content">
            <button id="reportBtn" class="btn btn-primary">Generate Report</button>
            <div id="reportResult" class="summary-box hidden">
                <h3 class="answer-subtitle">AI Report</h3>
                <div id="reportText"></div>
            </div>
        </div>
    </details>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <h4 class="footer-title">AI Medical Report Analyzer</h4>
                    <p class="footer-disclaimer-text">Providing AI-powered insights for informational purposes. Not a substitute for professional medical advice.</p>
                </div>
                <div class="footer-links">
                    <h4 class="footer-title">Navigate</h4>
                    <ul>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 AI Medical Report Analyzer. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script>
    (function() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file');
        const uploadForm = document.getElementById('uploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const changeFileBtn = document.getElementById('changeFileBtn');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const uploadSuccess = document.getElementById('uploadSuccess');
        const uploadError = document.getElementById('uploadError');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileStatus = document.getElementById('fileStatus');
        const askForm = document.getElementById('askForm');
        const queryEl = document.getElementById('query');
        const typing = document.getElementById('typing');
        const reportBtn = document.getElementById('reportBtn');
        const reportResult = document.getElementById('reportResult');
        const reportText = document.getElementById('reportText');

        // Helper functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showError(element, message) {
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        }

        // File upload handling
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileStatus.textContent = 'Ready to upload';
                    fileStatus.className = 'file-status ready';
                    uploadError.classList.add('hidden');
                    
                    // Enable the report button when a file is selected
                    if (reportBtn) {
                        reportBtn.disabled = false;
                    }
                }
            });
        }

        // Handle form submission
        if (uploadForm) {
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    showError(uploadError, 'Please select a file to upload');
                    return;
                }

                const formData = new FormData(uploadForm);

                try {
                    // Show loading state
                    uploadBtn.disabled = true;
                    uploadSpinner.classList.remove('hidden');
                    uploadSuccess.classList.add('hidden');
                    uploadError.classList.add('hidden');
                    fileStatus.textContent = 'Uploading...';
                    fileStatus.className = 'file-status uploading';

                    // Send the file to the server
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Upload failed');
                    }

                    // Show success message
                    uploadSuccess.textContent = '‚úÖ File uploaded and processed successfully';
                    uploadSuccess.classList.remove('hidden');
                    fileStatus.textContent = '‚úî Ready for analysis';
                    fileStatus.className = 'file-status uploaded';
                    
                    // Enable report generation
                    if (reportBtn) {
                        reportBtn.disabled = false;
                    }

                } catch (error) {
                    console.error('Upload error:', error);
                    showError(uploadError, error.message || 'Failed to upload file');
                    fileStatus.textContent = 'Upload failed';
                    fileStatus.className = 'file-status error';
                } finally {
                    uploadBtn.disabled = false;
                    uploadSpinner.classList.add('hidden');
                }
            });
        }

        // Report generation
        if (reportBtn) {
            // Initially disable the report button until a file is uploaded
            reportBtn.disabled = true;
            
            reportBtn.addEventListener('click', async () => {
                try {
                    // Update UI
                    reportBtn.disabled = true;
                    reportBtn.textContent = "‚è≥ Generating Report...";
                    reportResult.classList.remove('hidden');
                    reportText.textContent = "Processing your request...";
                    
                    // Clear any previous errors
                    const errorElement = reportResult.querySelector('.error');
                    if (errorElement) {
                        errorElement.remove();
                    }

                    // Make the API request
                    const response = await fetch('/structured-report');
                    
                    // Check for HTTP errors
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Server responded with status ${response.status}`);
                    }
                    
                    // Parse the JSON response
                    const data = await response.json();
                    
                    // Check for application-level errors
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Display the report
                    if (data.report) {
                        reportText.innerHTML = data.report.replace(/\n/g, '<br/>');
                    } else {
                        throw new Error('No report data received');
                    }
                    
                } catch (error) {
                    console.error('Error generating report:', error);
                    
                    // Create or update error element
                    let errorElement = reportResult.querySelector('.error');
                    if (!errorElement) {
                        errorElement = document.createElement('div');
                        errorElement.className = 'error';
                        reportResult.insertBefore(errorElement, reportText);
                    }
                    
                    errorElement.textContent = `‚ùå Error: ${error.message || 'Failed to generate report'}`;
                    reportText.textContent = '';
                    
                } finally {
                    // Always re-enable the button
                    reportBtn.disabled = false;
                    reportBtn.textContent = "Generate Report";
                }
            });
        }

        
        // Simple markdown-ish renderer for emphasis and breaks
        const renderMarkdown = (s = '') => s
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1<\/strong>')
            .replace(/\n\n/g, '<br/><br/>')
            .replace(/\n-\s+/g, '<br/>‚Ä¢ ');

        // Drag & drop
        if (dropzone && fileInput) {
            const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
            ['dragenter','dragover','dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, prevent));
            ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, () => dropzone.classList.add('is-dragover')));
            ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, () => dropzone.classList.remove('is-dragover')));
            
            // Click to select file
            dropzone.addEventListener('click', () => fileInput.click());
            
            // Handle dropped files
            dropzone.addEventListener('drop', (e) => {
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) {
                    // Only take the first file since we're doing single file uploads now
                    const file = e.dataTransfer.files[0];
                    
                    // Create a new FileList to hold the file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Update the UI to show the selected file
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileStatus.textContent = 'Ready to upload';
                    fileStatus.className = 'file-status ready';
                    uploadError.classList.add('hidden');
                    
                    // Update dropzone preview
                    dropzone.querySelector('.dropzone-title').textContent = file.name;
                    dropzone.querySelector('.dropzone-subtitle').textContent = formatFileSize(file.size);
                    
                    // Enable the report button when a file is selected
                    if (reportBtn) {
                        reportBtn.disabled = false;
                    }
                }
            });
            
            // Update dropzone preview when file is selected via input
            fileInput.addEventListener('change', () => {
                if (fileInput.files && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    
                    // Update the file info display
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileStatus.textContent = 'Ready to upload';
                    fileStatus.className = 'file-status ready';
                    uploadError.classList.add('hidden');
                    
                    // Update dropzone preview
                    dropzone.querySelector('.dropzone-title').textContent = file.name;
                    dropzone.querySelector('.dropzone-subtitle').textContent = formatFileSize(file.size);
                    
                    // Enable the report button when a file is selected
                    if (reportBtn) {
                        reportBtn.disabled = false;
                    }
                }
            });
        }

        // Change file action
        if (changeFileBtn && fileInput) {
            changeFileBtn.addEventListener('click', () => {
                fileInput.click();
            });
        }

        // File upload handling is now handled by the earlier code block
        // This section is intentionally left blank as the functionality was moved up

        // Composer auto-resize and Enter/Shift+Enter
        if (queryEl) {
            const autosize = () => {
                queryEl.style.height = 'auto';
                queryEl.style.height = Math.min(queryEl.scrollHeight, 200) + 'px';
            };
            queryEl.addEventListener('input', autosize);
            autosize();
            queryEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    askForm.requestSubmit();
                }
            });
        }

        // Typing indicator while waiting for response
        if (askForm && typing) {
            askForm.addEventListener('submit', () => {
                typing.classList.remove('hidden');
            });
        }

        // Copy and collapse actions
        document.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-btn');
            if (copyBtn) {
                const text = copyBtn.getAttribute('data-copy') || '';
                navigator.clipboard.writeText(text).then(() => {
                    copyBtn.textContent = '‚úÖ Copied';
                    setTimeout(() => copyBtn.textContent = 'üìã Copy', 1200);
                });
            }
        });

        // Smooth scroll for 'Get Started' button
        const ctaButton = document.querySelector('.hero-cta');
        if (ctaButton) {
            ctaButton.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                    // Open the details section after scrolling
                    setTimeout(() => {
                        targetElement.setAttribute('open', '');
                    }, 500); // Adjust delay as needed
                }
            });
        }

        // Accordion behavior
        const accordionItems = document.querySelectorAll('.accordion details');
        accordionItems.forEach(item => {
            item.addEventListener('toggle', (e) => {
                if (item.open) {
                    accordionItems.forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.removeAttribute('open');
                        }
                    });
                }
            });
        });

        // Risk Flag Display
        const displayRisk = () => {
            const alertEl = document.getElementById('riskAlert');
            if (!alertEl || !alertEl.dataset.risk) return;

            const riskText = alertEl.dataset.risk.toLowerCase();
            const iconEl = alertEl.querySelector('.risk-icon');
            const titleEl = alertEl.querySelector('.risk-title');
            const suggestionEl = alertEl.querySelector('.risk-suggestion');

            let riskLevel = 'low';
            if (riskText.includes('critical')) {
                riskLevel = 'critical';
            } else if (riskText.includes('high')) {
                riskLevel = 'high';
            } else if (riskText.includes('moderate')) {
                riskLevel = 'medium';
            }

            alertEl.classList.remove('risk-high', 'risk-medium', 'risk-low');

            if (riskLevel === 'critical') {
                alertEl.classList.add('risk-high'); // Use high-risk color for critical
                iconEl.textContent = '‚ùó';
                titleEl.textContent = 'Critical Risk';
            } else if (riskLevel === 'high') {
                alertEl.classList.add('risk-high');
                iconEl.textContent = '‚ùó';
                titleEl.textContent = 'High Risk';
            } else if (riskLevel === 'medium') {
                alertEl.classList.add('risk-medium');
                iconEl.textContent = '‚ö†Ô∏è';
                titleEl.textContent = 'Moderate Risk';
            } else {
                alertEl.classList.add('risk-low');
                iconEl.textContent = '‚úÖ';
                titleEl.textContent = 'Low Risk';
            }

            // Extract the suggestion part from the risk flag text
            const suggestionText = alertEl.dataset.risk.split('‚Üí')[1] || ' Please follow the advice provided.';
            suggestionEl.textContent = suggestionText.trim();
        };

        displayRisk();

        // Render structured AI answer if present
        const answerRoot = document.getElementById('aiAnswer');
        if (answerRoot) {
            const raw = JSON.parse(answerRoot.dataset.answer || '""');

            const md = (s) => s
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1<\/strong>')
                .replace(/\n\n/g, '<br/><br/>')
                .replace(/\n-\s+/g, '<br/>‚Ä¢ ');

            // naive segmentation by numbered sections added in prompt
            const shortMatch = raw.match(/1\)\s*Short[^:]*:\s*([\s\S]*?)(?=\n\s*2\)|$)/i);
            const detailMatch = raw.match(/2\)\s*Detailed[^:]*:\s*([\s\S]*?)(?=\n\s*3\)|$)/i);
            const refMatch = raw.match(/(3\)\s*Page[^:]*:\s*|Pages referenced:\s*)([\s\S]*?)(?=\n\s*4\)|$)/i);
            const nextMatch = raw.match(/4\)\s*[^:]*:\s*([\s\S]*)$/i);

            const shortEl = document.getElementById('answerShort');
            const detailsEl = document.getElementById('answerDetails');
            const refsEl = document.getElementById('answerRefs');
            const nextEl = document.getElementById('answerNext');

            if (shortEl) shortEl.innerHTML = md(shortMatch ? shortMatch[1].trim() : raw.split('\n')[0] || '');

            if (detailsEl) {
                const details = detailMatch ? detailMatch[1].trim() : '';
                if (/-\s+/.test(details)) {
                    const items = details.split(/\n\s*-\s+/).filter(Boolean);
                    const ul = document.createElement('ul');
                    ul.className = 'kv-list';
                    items.forEach((t) => {
                        const li = document.createElement('li');
                        li.innerHTML = md(t);
                        ul.appendChild(li);
                    });
                    detailsEl.appendChild(ul);
                } else {
                    detailsEl.innerHTML = md(details || '');
                }
            }

            if (refsEl) refsEl.innerHTML = md(refMatch ? (refMatch[2] || refMatch[1] || '').trim() : '‚Äî');
            if (nextEl) nextEl.innerHTML = md(nextMatch ? nextMatch[1].trim() : '');

        }

        // Structured Clinical Report generation
        const reportForm = document.getElementById('reportForm');
        const reportQuestionEl = document.getElementById('reportQuestion');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportSpinner = document.getElementById('reportSpinner');
        const reportOutput = document.getElementById('reportOutput');
        const reportContent = document.getElementById('reportContent');
        const reportRefs = document.getElementById('reportRefs');
        const copyReportBtn = document.getElementById('copyReportBtn');

        if (reportQuestionEl) {
            const autosize2 = () => {
                reportQuestionEl.style.height = 'auto';
                reportQuestionEl.style.height = Math.min(reportQuestionEl.scrollHeight, 200) + 'px';
            };
            reportQuestionEl.addEventListener('input', autosize2);
            autosize2();
        }

        if (reportForm) {
            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const question = (reportQuestionEl?.value || '').trim() || (queryEl?.value || '').trim();
                if (!question) {
                    alert('Please enter a question for the structured report.');
                    return;
                }

                try {
                    generateReportBtn.disabled = true;
                    reportSpinner.classList.remove('hidden');
                    reportOutput.classList.add('hidden');

                    const res = await fetch('/structured_report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question })
                    });
                    const data = await res.json().catch(() => ({}));

                    if (res.ok && data.ok) {
                        const report = data.report || '';
                        const refs = Array.isArray(data.references) ? data.references.join(', ') : '';
                        if (reportContent) reportContent.innerHTML = renderMarkdown(report);
                        if (reportRefs) reportRefs.innerHTML = renderMarkdown(refs || '‚Äî');
                        if (copyReportBtn) copyReportBtn.setAttribute('data-copy', report);
                        reportOutput.classList.remove('hidden');
                    } else {
                        alert((data && data.message) ? data.message : 'Failed to generate report');
                    }
                } catch (err) {
                    alert('Error generating report');
                } finally {
                    reportSpinner.classList.add('hidden');
                    generateReportBtn.disabled = false;
                }
            });
        }
    })();
    </script>
</body>
</html>
